<!DOCTYPE html>
<!--
Converts CSV files to KML.
Interaction is done via drag and drop while data is exported via local download.

The output file name is the original name concatenated with ".kml".
-->
<html>

    <head>
        <meta charset="UTF-8">
        <title>TheKarte-csv2kml</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.js"></script>
        <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.2.0/build/ol.js"></script>
    </head>

    <style>
    .dropArea {
        height: 30em;
        width: 30em;
        margin-top: 1em;
        margin-left: auto;
        margin-right: auto;
        border-style: dotted;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    </style>

    <script src="src/HelperDownload.js"></script>

    <script>
    /**
    Allow drop events.
    */
    function loadAllowDrop(event) {
        event.stopPropagation();
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    /**
    Handles drop events.
    */
    function loadDrop(event) {
        loadAllowDrop(event);

        var columnLatitude = document.getElementById('choice-latitude').value;
        var columnLongitude = document.getElementById('choice-longitude').value;

        if (!columnLatitude || columnLatitude.length == 0 || !columnLatitude || columnLatitude.length == 0) {
            console.error("TheKarte-csv2kml: no columns defined for coordinates.");
            return;
        }
        console.log("TheKarte-csv2kml: column latitude: " + columnLatitude + " and column longitude: " + columnLongitude);

        if (event.dataTransfer.types.indexOf("Files") >= 0) {
            var files = event.dataTransfer.files;

            for (var i = 0; i < files.length; i++) {
                console.log("TheKarte-csv2kml: got file (" + files[i].name + ").");

                let fileSuffix = files[i].name.split('.').pop();

                var format = null;
                var filenameFormat = null;

                switch (fileSuffix.toLowerCase()) {
                    case "csv":
                        format = convertCSV2KML;
                        filenameFormat = function(filename) {
                            return filename + ".kml"
                        };
                        break;
                    case "kml":
                        format = convertKML2CSV;
                        filenameFormat = function(filename) {
                            return filename + ".csv"
                        };
                        break;

                    default:
                        console.error("TheKarte-csv2kml: don't know how to read file with suffix: " + fileSuffix);
                        break
                }

                var reader = new FileReader();
                reader.onload = function() {
                    var contentFormatted = format(reader.result, columnLatitude, columnLongitude);
                    if (contentFormatted === undefined) {
                        console.error("TheKarte-csv2kml: could not convert data.");
                        return;
                    }

                    console.log("TheKarte-csv2kml: content of " + reader.filename);
                    console.log(contentFormatted);

                    TheKarteHelperDownload(filenameFormat(reader.filename), contentFormatted);
                };
                reader.onerror = function() {
                    console.log("TheKarte-csv2kml: error during reading: " + reader.error);
                };

                reader.filename = files[i].name;
                reader.readAsText(files[i]);
            }
        }
    }

    /**
    Converts loaded CSV data into KML string.
    Uses PapaParse to parse CSV.

    @param {string} csvString CSV data as string.
    @param {string} columnLatitude The CSV column containing the latitude.
    @param {string} columnLongitude The CSV column containing the longitude.
    @return {string} The KML data OR undefined.
    */
    function convertCSV2KML(csvString, columnLatitude, columnLongitude) {
        var csvPapa = Papa.parse(csvString, {
            header: true,
            trimHeader: true,
            dynamicTyping: true,
            skipEmptyLines: 'greedy'
        });
        var csvData = csvPapa.data;

        console.log("TheKarte-csv2kml: got " + csvData.length + " rows to convert into KML.");

        //Converting to Openlayers features.
        var features = new Array();
        for (var i = 0; i < csvData.length; i++) {
            if (csvData[i][columnLatitude] && csvData[i][columnLongitude]) {
                let latitude = string2number(csvData[i][columnLatitude]);
                let longitude = string2number(csvData[i][columnLongitude]);

                console.info("csv2kml: got (" + latitude + ", " + longitude + ")");
                let point = new ol.geom.Point([latitude, longitude]);
                let feature = new ol.Feature(point);

                delete csvData[i][columnLatitude];
                delete csvData[i][columnLongitude];
                feature.setProperties(csvData[i]);

                features.push(feature);
            }
        }

        return new ol.format.KML().writeFeatures(features);
    }

    /**
    Converts loaded KML data into CSV string.
    Uses PapaParse to unparse CSV.

    @param {string} kmlString KML data as string.
    @param {string} columnLatitude The CSV column containing the latitude.
    @param {string} columnLongitude The CSV column containing the longitude.
    @return {string} The CSV data OR undefined.
    */
    function convertKML2CSV(kmlString, columnLatitude, columnLongitude) {
        var features = new ol.format.KML().readFeatures(kmlString);

        console.log("TheKarte-csv2kml: got " + features.length + " features to convert into CSV.");

        //Converting to Openlayers features.
        var featuresCSV = new Array();
        for (var i = 0; i < features.length; i++) {
            let coordinates = features[i].getGeometry().getCoordinates();

            //Get coordinates
            let featureData = {};
            featureData[columnLatitude] = coordinates[0];
            featureData[columnLongitude] = coordinates[1];

            //Get data
            featureProperties = features[i].getProperties();
            for (var key in featureProperties) {
                if (key != features[i].getGeometryName())
                    featureData[key] = featureProperties[key];
            }

            featuresCSV.push(featureData);
        }

        var exportString = Papa.unparse(featuresCSV, {
            quotes: false,
            quoteChar: '"',
            escapeChar: '"',
            delimiter: ",",
            header: true,
            newline: "\r\n"
        });

        return exportString;
    }

    /**
    Localization: parses stringified number.
    Accounts for european decimal separator before parsing.

    @param {string} str One stringified number.
    */
    function string2number(str) {
        if (typeof str === 'string' && str.includes(',')) {
            return str.replace(',', '.');
        }
        return str;
    }

    </script>

    <body style="height:100%; margin: 0;">
        <div style="position: fixed; height: 100%; width: 100%; text-align: center; vertical-align: center">

            <h1>TheKarte: CSV2KML</h1>

            <p>
                How to use:
                <ol>
                    <li>Set the columns for longitude and latitude</li>
                    <li>Drag and drop the <i>CSV files</i> or <i>KML files</i> to be converted onto the drop area.</li>
                    <li>Each file is processed individually and automatically downloaded to your download-folder.</li>
                </ol>

                <b>NOTE:</b> If something went wrong, no file is downloaded.
            </p>

            <table style="margin-left: auto; margin-right:auto;">
                <tr>
                    <td align="right"><label for="choice-latitude">Latitude column:</label></td>
                    <td align="left">
                        <input list="latitude-flavors" id="choice-latitude" />

                        <datalist id="latitude-flavors">
                        <option value="x">
                        <option value="Latitude">
                        <option value="lat">
                    </datalist> </td>
                </tr>
                <tr>
                    <td align="right"><label for="choice-longitude">Longitude column:</label></td>
                    <td align="left">
                        <input list="longitude-flavors" id="choice-longitude" />
                        <datalist id="longitude-flavors">
                            <option value="y">
                            <option value="longitude">
                            <option value="lon">
                        </datalist>
                    </td>
                </tr>
            </table>

            <div class="dropArea" ondragover="loadAllowDrop(event)" ondrop="loadDrop(event)">
                <div>DROP AREA</div>
            </div>
        </div>
    </body>

</html>
